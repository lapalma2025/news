import { generateId } from '../utils/helpers';
import { VALIDATION_RULES } from '../utils/constants';

export const citizenBoxService = {
    async submitCitizenReport(reportData) {
        console.log('üì• submitCitizenReport called with:', reportData);

        try {
            // Walidacja danych
            const validation = this.validateReportData(reportData);
            console.log('‚úÖ Validation result:', validation);

            if (!validation.isValid) {
                return {
                    success: false,
                    error: validation.errors.join(', ')
                };
            }

            // Przygotowanie danych do wys≈Çania
            const submissionData = {
                id: generateId(12),
                title: reportData.title.trim(),
                description: reportData.description.trim(),
                category: reportData.category,
                location: reportData.location?.trim() || '',
                email: reportData.email.trim(),
                allowContact: reportData.allowContact,
                timestamp: new Date().toISOString(),
                status: 'pending_moderation',
            };

            // Wys≈Çanie emaila przez EmailJS
            const emailResult = await this.sendEmailViaNative(submissionData);
            console.log('üìß Email result:', emailResult);

            if (emailResult.success) {
                // Zapisz w lokalnej historii
                await this.saveToLocalHistory(submissionData);

                return {
                    success: true,
                    data: submissionData,
                    message: 'Zg≈Çoszenie zosta≈Ço wys≈Çane pomy≈õlnie!'
                };
            } else {
                return {
                    success: false,
                    error: emailResult.error || 'Nie uda≈Ço siƒô wys≈Çaƒá zg≈Çoszenia. Spr√≥buj ponownie.'
                };
            }

        } catch (error) {
            console.error('Error submitting citizen report:', error);
            return {
                success: false,
                error: 'WystƒÖpi≈Ç b≈ÇƒÖd podczas wysy≈Çania zg≈Çoszenia'
            };
        }
    },

    async sendEmailViaEmailJS(submissionData) {
        try {
            console.log('üöÄ Starting email send process...');

            // Sprawd≈∫ czy to przeglƒÖdarka czy React Native
            const isWeb = typeof window !== 'undefined' && window.document;

            if (!isWeb) {
                // React Native - u≈ºyj natywnego modu≈Çu email
                return await this.sendEmailViaNative(submissionData);
            }

            const EMAILJS_CONFIG = {
                serviceId: 'service_zpe4694',
                templateId: 'template_ujvy5sn',
                publicKey: 'OtMMkrZ1-8s-MZqxT'
            };

            console.log('üìß EmailJS Config:', EMAILJS_CONFIG);
            console.log('üìù Submission data:', submissionData);

            const categoryLabels = this.getCategoryLabels();

            // Dane do wys≈Çania przez EmailJS
            const templateParams = {
                to_email: 'wiem.biuro@gmail.com',
                from_email: submissionData.email,
                subject: `üèõÔ∏è Nowe zg≈Çoszenie obywatelskie - ${submissionData.title}`,
                title: submissionData.title,
                category: categoryLabels[submissionData.category] || submissionData.category,
                location: submissionData.location || 'Nie podano',
                description: submissionData.description,
                user_email: submissionData.email,
                allow_contact: submissionData.allowContact ? 'Tak' : 'Nie',
                date: new Date(submissionData.timestamp).toLocaleDateString('pl-PL', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                report_id: submissionData.id
            };

            console.log('üìã Template params:', templateParams);

            const requestBody = {
                service_id: EMAILJS_CONFIG.serviceId,
                template_id: EMAILJS_CONFIG.templateId,
                user_id: EMAILJS_CONFIG.publicKey,
                template_params: templateParams
            };

            console.log('üì§ Request body:', requestBody);
            console.log('üåê Sending request to EmailJS API...');

            // Wys≈Çanie emaila przez EmailJS
            const response = await fetch('https://api.emailjs.com/api/v1.0/email/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            console.log('üì° Response status:', response.status);
            console.log('üì° Response headers:', response.headers);

            const responseText = await response.text();
            console.log('üìÑ Response text:', responseText);

            if (response.ok) {
                console.log('‚úÖ Email sent successfully!');
                return { success: true };
            } else {
                console.error('‚ùå EmailJS Error - Status:', response.status);
                console.error('‚ùå EmailJS Error - Response:', responseText);
                return {
                    success: false,
                    error: `B≈ÇƒÖd wysy≈Çania emaila (${response.status}): ${responseText}`
                };
            }

        } catch (error) {
            console.error('üí• Email sending error:', error);
            console.error('üí• Error stack:', error.stack);
            return {
                success: false,
                error: `B≈ÇƒÖd po≈ÇƒÖczenia z serwerem email: ${error.message}`
            };
        }
    },

    async sendEmailViaNative(submissionData) {
        try {
            console.log('üì± Attempting EmailJS bypass for React Native...');

            // Przygotuj dane tak jak na web
            const EMAILJS_CONFIG = {
                serviceId: 'service_zpe4694',
                templateId: 'template_ujvy5sn',
                publicKey: 'OtMMkrZ1-8s-MZqxT'
            };

            const categoryLabels = this.getCategoryLabels();

            const templateParams = {
                to_email: 'wiem.biuro@gmail.com',
                from_email: submissionData.email,
                subject: `üèõÔ∏è Nowe zg≈Çoszenie obywatelskie - ${submissionData.title}`,
                title: submissionData.title,
                category: categoryLabels[submissionData.category] || submissionData.category,
                location: submissionData.location || 'Nie podano',
                description: submissionData.description,
                user_email: submissionData.email,
                allow_contact: submissionData.allowContact ? 'Tak' : 'Nie',
                date: new Date(submissionData.timestamp).toLocaleDateString('pl-PL', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                report_id: submissionData.id
            };

            const headers = {
                'Content-Type': 'application/json',
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                'Origin': 'https://localhost:3000',
                'Referer': 'https://localhost:3000/',
                'Accept': 'application/json, text/plain, */*',
                'Accept-Language': 'pl-PL,pl;q=0.9,en;q=0.8'
            };

            const requestBody = {
                service_id: EMAILJS_CONFIG.serviceId,
                template_id: EMAILJS_CONFIG.templateId,
                user_id: EMAILJS_CONFIG.publicKey,
                template_params: templateParams
            };

            console.log('üé≠ Sending with browser headers...');
            console.log('üì§ Request body:', requestBody);

            const response = await fetch('https://api.emailjs.com/api/v1.0/email/send', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            console.log('üì° Response status:', response.status);
            const responseText = await response.text();
            console.log('üìÑ Response text:', responseText);

            if (response.ok) {
                console.log('‚úÖ Email sent via EmailJS bypass!');
                return { success: true };
            } else {
                console.error('‚ùå EmailJS bypass failed:', response.status, responseText);

                // Fallback do Linking jako backup
                console.log('üîÑ Falling back to Linking...');
                return await this.sendEmailViaLinking(submissionData);
            }

        } catch (error) {
            console.error('üí• EmailJS bypass error:', error);

            // Fallback do Linking jako backup
            console.log('üîÑ Falling back to Linking...');
            return await this.sendEmailViaLinking(submissionData);
        }
    },

    async sendEmailViaLinking(submissionData) {
        try {
            const { Linking } = await import('react-native');
            const categoryLabels = this.getCategoryLabels();

            const subject = encodeURIComponent(`üèõÔ∏è Zg≈Çoszenie obywatelskie - ${submissionData.title}`);
            const body = encodeURIComponent(`üèõÔ∏è SKRZYNKA OBYWATELA
    
    Tytu≈Ç: ${submissionData.title}
    Kategoria: ${categoryLabels[submissionData.category]}
    Lokalizacja: ${submissionData.location || 'Nie podano'}
    Data: ${new Date(submissionData.timestamp).toLocaleDateString('pl-PL')}
    
    OPIS: ${submissionData.description}
    
    Email: ${submissionData.email}
    Zgoda na kontakt: ${submissionData.allowContact ? 'Tak' : 'Nie'}
    ID: ${submissionData.id}`);

            const emailUrl = `mailto:wiem.biuro@gmail.com?subject=${subject}&body=${body}`;

            const canOpen = await Linking.canOpenURL(emailUrl);
            if (canOpen) {
                await Linking.openURL(emailUrl);
                return { success: true, method: 'linking' };
            } else {
                return { success: false, error: 'Brak aplikacji email' };
            }
        } catch (error) {
            return { success: false, error: 'Nie mo≈ºna otworzyƒá email' };
        }
    },

    validateReportData(data) {
        const errors = [];

        if (!data.title || data.title.trim().length < 5) {
            errors.push('Tytu≈Ç musi mieƒá co najmniej 10 znak√≥w');
        }

        if (data.title && data.title.trim().length > 100) {
            errors.push('Tytu≈Ç mo≈ºe mieƒá maksymalnie 100 znak√≥w');
        }

        if (!data.description || data.description.trim().length < 10) {
            errors.push('Opis musi mieƒá co najmniej 20 znak√≥w');
        }

        if (data.description && data.description.trim().length > 500) {
            errors.push('Opis mo≈ºe mieƒá maksymalnie 500 znak√≥w');
        }

        if (!data.email || !VALIDATION_RULES.EMAIL.test(data.email)) {
            errors.push('Podaj prawid≈Çowy adres email');
        }

        if (!data.category) {
            errors.push('Wybierz kategoriƒô problemu');
        }

        return {
            isValid: errors.length === 0,
            errors
        };
    },

    async saveToLocalHistory(submissionData) {
        try {
            const AsyncStorage = require('@react-native-async-storage/async-storage').default;
            const existingHistory = await this.getCitizenReportsHistory();
            const updatedHistory = [submissionData, ...existingHistory].slice(0, 50);
            await AsyncStorage.setItem('@infoapp:citizenReports', JSON.stringify(updatedHistory));
            return true;
        } catch (error) {
            console.error('Error saving to local history:', error);
            return false;
        }
    },

    async getCitizenReportsHistory() {
        try {
            const AsyncStorage = require('@react-native-async-storage/async-storage').default;
            const history = await AsyncStorage.getItem('@infoapp:citizenReports');
            return history ? JSON.parse(history) : [];
        } catch (error) {
            console.error('Error getting citizen reports history:', error);
            return [];
        }
    },

    getCategoryLabels() {
        return {
            'infrastruktura': 'üöß Infrastruktura',
            'transport': 'üöå Transport publiczny',
            'srodowisko': 'üå± ≈örodowisko',
            'bezpieczenstwo': 'üöî Bezpiecze≈Ñstwo',
            'edukacja': 'üéì Edukacja',
            'zdrowie': 'üè• S≈Çu≈ºba zdrowia',
            'kultura': 'üé≠ Kultura i sport',
            'inne': 'üìù Inne'
        };
    },

    getReportCategories() {
        return [
            { value: 'infrastruktura', label: 'üöß Infrastruktura', color: '#ef4444' },
            { value: 'transport', label: 'üöå Transport publiczny', color: '#f59e0b' },
            { value: 'srodowisko', label: 'üå± ≈örodowisko', color: '#10b981' },
            { value: 'bezpieczenstwo', label: 'üöî Bezpiecze≈Ñstwo', color: '#3b82f6' },
            { value: 'edukacja', label: 'üéì Edukacja', color: '#8b5cf6' },
            { value: 'zdrowie', label: 'üè• S≈Çu≈ºba zdrowia', color: '#06b6d4' },
            { value: 'kultura', label: 'üé≠ Kultura i sport', color: '#ec4899' },
            { value: 'inne', label: 'üìù Inne', color: '#6b7280' }
        ];
    }
};